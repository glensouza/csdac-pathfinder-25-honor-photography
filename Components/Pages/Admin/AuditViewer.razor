@page "/admin/audit"
@using PathfinderPhotography.Services
@using PathfinderPhotography.Models
@using PathfinderPhotography.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Microsoft.EntityFrameworkCore.IDbContextFactory<PathfinderPhotography.Data.ApplicationDbContext> ContextFactory
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Audit Trail</PageTitle>

<div class="container mt-4">
    <h1>Audit Trail</h1>

    @if (!isAdmin)
    {
        <div class="alert alert-danger">
            <h4>Access Denied</h4>
            <p>You must be an admin to access this page.</p>
            <a href="/" class="btn btn-primary">Return to Home</a>
        </div>
    }
    else
    {
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <div class="d-flex gap-2 align-items-center">
                <label class="form-label mb-0 me-2">Filter by Action</label>
                <select class="form-select d-inline-block w-auto" @bind="selectedAction">
                    <option value="">All</option>
                    @foreach (string action in actions)
                    {
                        <option value="@action">@action</option>
                    }
                </select>

                <label class="form-label mb-0 ms-3 me-2">Search</label>
                <input class="form-control form-control-sm" style="width: 220px;" placeholder="actor, details..." @bind="searchTerm" @bind:event="oninput" />

                <button class="btn btn-secondary btn-sm ms-2" @onclick="ApplyFilters">Apply</button>
            </div>

            <div class="d-flex gap-2 align-items-center">
                <label class="form-label mb-0 me-2">Page size</label>
                <select class="form-select form-select-sm w-auto" @bind="pageSize">
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <button class="btn btn-secondary btn-sm" @onclick="LoadAudit">Refresh</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th style="width: 160px">Time (UTC)</th>
                        <th style="width: 120px">Action</th>
                        <th style="width: 80px">EntityId</th>
                        <th style="width: 200px">Actor</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (AuditLog entry in entries)
                    {
                        <tr>
                            <td>@entry.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td>@entry.Action</td>
                            <td>@entry.EntityId</td>
                            <td>@entry.ActorEmail</td>
                            <td>@entry.Details</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-2">
            <div>
                <small class="text-muted">Showing @((currentPage-1)*pageSize + 1) - @Math.Min(currentPage*pageSize, totalCount) of @totalCount</small>
            </div>
            <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-secondary" @onclick="PreviousPage" disabled="@(currentPage == 1)">Previous</button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="NextPage" disabled="@(currentPage >= totalPages)">Next</button>
            </div>
        </div>
    }
</div>

@code {
    private bool isAdmin = false;
    private List<AuditLog> entries = new();
    private List<string> actions = new();
    private string selectedAction = string.Empty;
    private string searchTerm = string.Empty;

    private int pageSize = 20;
    private int currentPage = 1;
    private int totalCount = 0;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        AuthenticationState authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            string? email = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
            if (!string.IsNullOrEmpty(email))
            {
                // Check role via DB
                await using var context = await ContextFactory.CreateDbContextAsync();
                var dbUser = await context.Users.FirstOrDefaultAsync(u => u.Email == email);
                if (dbUser != null && dbUser.Role == UserRole.Admin)
                {
                    isAdmin = true;
                }
            }
        }

        if (isAdmin)
        {
            await LoadAudit();
        }
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadAudit();
    }

    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        currentPage = 1;
        await LoadAudit();
    }

    private async Task LoadAudit()
    {
        await using var context = await ContextFactory.CreateDbContextAsync();
        IQueryable<AuditLog> query = context.AuditLogs.OrderByDescending(a => a.Timestamp).AsNoTracking();

        if (!string.IsNullOrEmpty(selectedAction))
        {
            query = query.Where(a => a.Action == selectedAction);
        }

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            string term = searchTerm.ToLower();
            query = query.Where(a => EF.Functions.ILike(a.Details, $"%{term}%") || EF.Functions.ILike(a.ActorEmail, $"%{term}%") || EF.Functions.ILike(a.Action, $"%{term}%"));
        }

        totalCount = await query.CountAsync();
        totalPages = Math.Max(1, (int)Math.Ceiling(totalCount / (double)pageSize));
        if (currentPage > totalPages) currentPage = totalPages;

        entries = await query.Skip((currentPage - 1) * pageSize).Take(pageSize).ToListAsync();
        actions = await context.AuditLogs.Select(a => a.Action).Distinct().OrderBy(a => a).ToListAsync();
    }

    private async Task PreviousPage()
    {
        if (currentPage <= 1) return;
        currentPage--;
        await LoadAudit();
    }

    private async Task NextPage()
    {
        if (currentPage >= totalPages) return;
        currentPage++;
        await LoadAudit();
    }
}
