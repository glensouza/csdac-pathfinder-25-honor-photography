@page "/admin/dashboard"
@using System.Security.Claims
@using PathfinderPhotography.Services
@using PathfinderPhotography.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@inject PhotoSubmissionService SubmissionService
@inject UserService UserService
@inject CompositionRuleService RuleService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Admin Dashboard</PageTitle>

<div class="container-fluid mt-4">
    <h1>Admin Dashboard</h1>
    <p class="lead">Overview of all photography submissions and statistics</p>

    @if (!isAdmin)
    {
        <div class="alert alert-danger">
            <h4>Access Denied</h4>
            <p>You must be an admin to access this page.</p>
            <a href="/" class="btn btn-primary">Return to Home</a>
        </div>
    }
    else
    {
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Submissions</h5>
                        <h2 class="mb-0">@statistics.TotalSubmissions</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">Pending Review</h5>
                        <h2 class="mb-0">@statistics.PendingSubmissions</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Passed</h5>
                        <h2 class="mb-0">@statistics.PassedSubmissions</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">Failed</h5>
                        <h2 class="mb-0">@statistics.FailedSubmissions</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Statistics Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">ðŸ¤– With AI Analysis</h5>
                        <h2 class="mb-0">@statistics.SubmissionsWithAi <small class="fs-6">/ @statistics.TotalSubmissions</small></h2>
                        <small>@((statistics.TotalSubmissions > 0 ? (statistics.SubmissionsWithAi * 100.0 / statistics.TotalSubmissions) : 0).ToString("F0"))% coverage</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-secondary text-white">
                    <div class="card-body">
                        <h5 class="card-title">ðŸ“Š Average AI Rating</h5>
                        <h2 class="mb-0">@statistics.AverageAiRating.ToString("F1") <small class="fs-6">/ 10</small></h2>
                        <small>Based on @statistics.SubmissionsWithAiRating submissions</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">User Statistics</h5>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td>Total Users</td>
                                    <td><strong>@statistics.TotalUsers</strong></td>
                                </tr>
                                <tr>
                                    <td>Pathfinders</td>
                                    <td><strong>@statistics.PathfinderCount</strong></td>
                                </tr>
                                <tr>
                                    <td>Instructors</td>
                                    <td><strong>@statistics.InstructorCount</strong></td>
                                </tr>
                                <tr>
                                    <td>Admins</td>
                                    <td><strong>@statistics.AdminCount</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Quick Actions</h5>
                        <div class="d-grid gap-2">
                            <a href="/grading" class="btn btn-primary">Grade Submissions</a>
                            <a href="/admin/users" class="btn btn-info">Manage Users</a>
                            <a href="/admin/ai-management" class="btn btn-warning">ðŸ¤– Manage AI Analysis</a>
                            <button class="btn btn-success" @onclick="ExportToPdf">Export to PDF</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submissions by Rule -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Submissions by Composition Rule</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Rule</th>
                                        <th>Total</th>
                                        <th>Not Graded</th>
                                        <th>Passed</th>
                                        <th>Failed</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (RuleStatistic stat in ruleStatistics)
                                    {
                                        <tr>
                                            <td>@stat.RuleName</td>
                                            <td>@stat.Total</td>
                                            <td>@stat.NotGraded</td>
                                            <td>@stat.Passed</td>
                                            <td>@stat.Failed</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Recent Submissions</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Pathfinder</th>
                                        <th>Rule</th>
                                        <th>Submitted</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (PhotoSubmission submission in recentSubmissions)
                                    {
                                        <tr>
                                            <td>@submission.PathfinderName</td>
                                            <td>@submission.CompositionRuleName</td>
                                            <td>@submission.SubmissionDate.ToString("MMM dd, yyyy HH:mm")</td>
                                            <td>
                                                @switch (submission.GradeStatus)
                                                {
                                                    case GradeStatus.NotGraded:
                                                        <span class="badge bg-secondary">Not Graded</span>
                                                        break;
                                                    case GradeStatus.Pass:
                                                        <span class="badge bg-success">âœ“ Pass</span>
                                                        break;
                                                    case GradeStatus.Fail:
                                                        <span class="badge bg-danger">âœ— Fail</span>
                                                        break;
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isAdmin = false;
    private DashboardStatistics statistics = new();
    private List<RuleStatistic> ruleStatistics = [];
    private List<PhotoSubmission> recentSubmissions = [];

    protected override async Task OnInitializedAsync()
    {
        AuthenticationState authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        ClaimsPrincipal user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            string currentUserEmail = user.FindFirst(ClaimTypes.Email)?.Value ?? "";
            string currentUserName = user.FindFirst(ClaimTypes.Name)?.Value ?? "";
            
            if (!string.IsNullOrEmpty(currentUserEmail))
            {
                await UserService.GetOrCreateUserAsync(currentUserEmail, currentUserName);
                isAdmin = await UserService.IsAdminAsync(currentUserEmail);
            }
        }

        if (!isAdmin)
        {
            return;
        }

        await LoadStatistics();
    }

    private async Task LoadStatistics()
    {
        List<PhotoSubmission> allSubmissions = await SubmissionService.GetAllSubmissionsAsync();
        List<User> allUsers = await UserService.GetAllUsersAsync();
        List<CompositionRule> rules = RuleService.GetAllRules();

        statistics = new DashboardStatistics
        {
            TotalSubmissions = allSubmissions.Count,
            PendingSubmissions = allSubmissions.Count(s => s.GradeStatus == GradeStatus.NotGraded),
            PassedSubmissions = allSubmissions.Count(s => s.GradeStatus == GradeStatus.Pass),
            FailedSubmissions = allSubmissions.Count(s => s.GradeStatus == GradeStatus.Fail),
            TotalUsers = allUsers.Count,
            PathfinderCount = allUsers.Count(u => u.Role == UserRole.Pathfinder),
            InstructorCount = allUsers.Count(u => u.Role == UserRole.Instructor),
            AdminCount = allUsers.Count(u => u.Role == UserRole.Admin),
            SubmissionsWithAi = allSubmissions.Count(s => !string.IsNullOrEmpty(s.AiTitle) || s.AiRating.HasValue),
            SubmissionsWithAiRating = allSubmissions.Count(s => s.AiRating.HasValue),
            AverageAiRating = allSubmissions.Where(s => s.AiRating.HasValue).Select(s => (double)s.AiRating!.Value).DefaultIfEmpty(0).Average()
        };

        ruleStatistics = rules.Select(rule => new RuleStatistic
        {
            RuleName = rule.Name,
            Total = allSubmissions.Count(s => s.CompositionRuleId == rule.Id),
            NotGraded = allSubmissions.Count(s => s.CompositionRuleId == rule.Id && s.GradeStatus == GradeStatus.NotGraded),
            Passed = allSubmissions.Count(s => s.CompositionRuleId == rule.Id && s.GradeStatus == GradeStatus.Pass),
            Failed = allSubmissions.Count(s => s.CompositionRuleId == rule.Id && s.GradeStatus == GradeStatus.Fail)
        }).ToList();

        recentSubmissions = allSubmissions
            .OrderByDescending(s => s.SubmissionDate)
            .Take(10)
            .ToList();
    }

    private void ExportToPdf()
    {
        // Navigate to export page or trigger export
        NavigationManager.NavigateTo("/admin/export");
    }

    private class DashboardStatistics
    {
        public int TotalSubmissions { get; set; }
        public int PendingSubmissions { get; set; }
        public int PassedSubmissions { get; set; }
        public int FailedSubmissions { get; set; }
        public int TotalUsers { get; set; }
        public int PathfinderCount { get; set; }
        public int InstructorCount { get; set; }
        public int AdminCount { get; set; }
        public int SubmissionsWithAi { get; set; }
        public int SubmissionsWithAiRating { get; set; }
        public double AverageAiRating { get; set; }
    }

    private class RuleStatistic
    {
        public string RuleName { get; set; } = string.Empty;
        public int Total { get; set; }
        public int NotGraded { get; set; }
        public int Passed { get; set; }
        public int Failed { get; set; }
    }
}
