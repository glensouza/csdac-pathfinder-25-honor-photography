@page "/top-photos"
@using PathfinderPhotography.Services
@using PathfinderPhotography.Models
@inject VotingService VotingService
@inject CompositionRuleService CompositionRuleService
@rendermode InteractiveServer

<PageTitle>Top Ranked Photos</PageTitle>

<div class="container mt-4">
    <h1>üèÜ Top Ranked Photos by Composition Rule</h1>
    <p class="lead">Photos ranked by community votes using the ELO rating system, organized by composition rule</p>

    <div class="mb-3">
        <p class="text-muted">
            <small>
                <strong>How it works:</strong> Each photo starts with a rating of 1000. 
                When people vote between photos of the same composition rule, ratings are adjusted based on expected outcomes. 
                Higher ratings indicate photos that consistently win comparisons within their rule category.
            </small>
        </p>
    </div>

    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading top photos...</p>
        </div>
    }
    else
    {
        @foreach (CompositionRule rule in compositionRules)
        {
            List<PhotoSubmission> rulePassedPhotos = topPhotosByRule.ContainsKey((rule.Id, GradeStatus.Pass)) 
                ? topPhotosByRule[(rule.Id, GradeStatus.Pass)] 
                : [];
            List<PhotoSubmission> ruleUngradedPhotos = topPhotosByRule.ContainsKey((rule.Id, GradeStatus.NotGraded)) 
                ? topPhotosByRule[(rule.Id, GradeStatus.NotGraded)] 
                : [];
            List<PhotoSubmission> ruleFailedPhotos = topPhotosByRule.ContainsKey((rule.Id, GradeStatus.Fail)) 
                ? topPhotosByRule[(rule.Id, GradeStatus.Fail)] 
                : [];
            
            bool hasPhotos = rulePassedPhotos.Any() || ruleUngradedPhotos.Any() || ruleFailedPhotos.Any();
            
            if (hasPhotos)
            {
                <div class="composition-rule-section mb-5">
                    <h2 class="border-bottom pb-2 mb-4">
                        üì∏ @rule.Name
                    </h2>
                    
                    @* Top Graded and Passed Photos for this rule *@
                    @if (rulePassedPhotos.Any())
                    {
                        <div class="mb-4">
                            <h3 class="h5 mb-3 text-success">‚úÖ Top Passed Photos</h3>
                            <div class="row">
                                @foreach ((PhotoSubmission photo, int index) in rulePassedPhotos.Select((p, i) => (p, i)))
                                {
                                    <div class="col-md-6 col-lg-4 mb-4">
                                        <div class="card h-100 @GetRankClass(index)">
                                            @if (index < 3)
                                            {
                                                <div class="position-absolute top-0 start-0 m-2">
                                                    <span class="badge @GetBadgeClass(index) fs-5">@GetRankIcon(index) #@(index + 1)</span>
                                                </div>
                                            }
                                            <img src="/api/images/@photo.Id" 
                                                 class="card-img-top" 
                                                 alt="@photo.CompositionRuleName by @photo.PathfinderName"
                                                 style="height: 300px; object-fit: cover; cursor: pointer;"
                                                 @onclick="() => ShowModal(photo)" />
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0">
                                                        @if (index >= 3)
                                                        {
                                                            <span class="badge bg-secondary me-1">#@(index + 1)</span>
                                                        }
                                                        @photo.PathfinderName
                                                    </h6>
                                                    <span class="badge bg-info">@Math.Round(photo.EloRating, 0)</span>
                                                </div>
                                                <p class="card-text">
                                                    <small class="text-muted">@photo.SubmissionDate.ToString("MMM dd, yyyy")</small>
                                                </p>
                                                <span class="badge bg-success">‚úì Pass</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    @* Top Ungraded Photos for this rule *@
                    @if (ruleUngradedPhotos.Any())
                    {
                        <div class="mb-4">
                            <h3 class="h5 mb-3 text-secondary">‚è≥ Top Ungraded Photos</h3>
                            <div class="row">
                                @foreach ((PhotoSubmission photo, int index) in ruleUngradedPhotos.Select((p, i) => (p, i)))
                                {
                                    <div class="col-md-6 col-lg-4 mb-4">
                                        <div class="card h-100 @GetRankClass(index)">
                                            @if (index < 3)
                                            {
                                                <div class="position-absolute top-0 start-0 m-2">
                                                    <span class="badge @GetBadgeClass(index) fs-5">@GetRankIcon(index) #@(index + 1)</span>
                                                </div>
                                            }
                                            <img src="/api/images/@photo.Id" 
                                                 class="card-img-top" 
                                                 alt="@photo.CompositionRuleName by @photo.PathfinderName"
                                                 style="height: 300px; object-fit: cover; cursor: pointer;"
                                                 @onclick="() => ShowModal(photo)" />
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0">
                                                        @if (index >= 3)
                                                        {
                                                            <span class="badge bg-secondary me-1">#@(index + 1)</span>
                                                        }
                                                        @photo.PathfinderName
                                                    </h6>
                                                    <span class="badge bg-info">@Math.Round(photo.EloRating, 0)</span>
                                                </div>
                                                <p class="card-text">
                                                    <small class="text-muted">@photo.SubmissionDate.ToString("MMM dd, yyyy")</small>
                                                </p>
                                                <span class="badge bg-secondary">Not Graded</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    @* Top Failed Photos for this rule *@
                    @if (ruleFailedPhotos.Any())
                    {
                        <div class="mb-4">
                            <h3 class="h5 mb-3 text-danger">‚ùå Top Failed Photos</h3>
                            <div class="row">
                                @foreach ((PhotoSubmission photo, int index) in ruleFailedPhotos.Select((p, i) => (p, i)))
                                {
                                    <div class="col-md-6 col-lg-4 mb-4">
                                        <div class="card h-100 @GetRankClass(index)">
                                            @if (index < 3)
                                            {
                                                <div class="position-absolute top-0 start-0 m-2">
                                                    <span class="badge @GetBadgeClass(index) fs-5">@GetRankIcon(index) #@(index + 1)</span>
                                                </div>
                                            }
                                            <img src="/api/images/@photo.Id" 
                                                 class="card-img-top" 
                                                 alt="@photo.CompositionRuleName by @photo.PathfinderName"
                                                 style="height: 300px; object-fit: cover; cursor: pointer;"
                                                 @onclick="() => ShowModal(photo)" />
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0">
                                                        @if (index >= 3)
                                                        {
                                                            <span class="badge bg-secondary me-1">#@(index + 1)</span>
                                                        }
                                                        @photo.PathfinderName
                                                    </h6>
                                                    <span class="badge bg-info">@Math.Round(photo.EloRating, 0)</span>
                                                </div>
                                                <p class="card-text">
                                                    <small class="text-muted">@photo.SubmissionDate.ToString("MMM dd, yyyy")</small>
                                                </p>
                                                <span class="badge bg-danger">‚úó Fail</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        }

        @if (!topPhotosByRule.Any())
        {
            <div class="alert alert-info">
                <p class="mb-0">No photos have been ranked yet. <a href="/vote">Start voting</a> to build the rankings!</p>
            </div>
        }
    }

    <div class="mt-4">
        <a href="/vote" class="btn btn-primary">Vote on Photos</a>
        <a href="/" class="btn btn-outline-secondary ms-2">‚Üê Back to Home</a>
    </div>
</div>

@if (selectedSubmission != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@selectedSubmission.CompositionRuleName</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <img src="/api/images/@selectedSubmission.Id" 
                         class="img-fluid mb-3" 
                         alt="@selectedSubmission.CompositionRuleName" />
                    <p><strong>Pathfinder:</strong> @selectedSubmission.PathfinderName</p>
                    <p><strong>ELO Rating:</strong> @Math.Round(selectedSubmission.EloRating, 1)</p>
                    <p><strong>Submitted:</strong> @selectedSubmission.SubmissionDate.ToString("MMMM dd, yyyy")</p>
                    <p><strong>Description:</strong></p>
                    <p>@selectedSubmission.Description</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .rank-gold {
        border: 3px solid gold;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
    }

    .rank-silver {
        border: 3px solid silver;
        box-shadow: 0 0 15px rgba(192, 192, 192, 0.5);
    }

    .rank-bronze {
        border: 3px solid #cd7f32;
        box-shadow: 0 0 15px rgba(205, 127, 50, 0.5);
    }
    
    .composition-rule-section {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
    }
</style>

@code {
    private Dictionary<(int ruleId, GradeStatus status), List<PhotoSubmission>> topPhotosByRule = new();
    private List<CompositionRule> compositionRules = [];
    private PhotoSubmission? selectedSubmission;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        compositionRules = CompositionRuleService.GetAllRules();
        
        foreach (CompositionRule rule in compositionRules)
        {
            List<PhotoSubmission> passedPhotos = await VotingService.GetTopPhotosByCompositionRuleAndGradeStatusAsync(rule.Id, GradeStatus.Pass, 10);
            List<PhotoSubmission> ungradedPhotos = await VotingService.GetTopPhotosByCompositionRuleAndGradeStatusAsync(rule.Id, GradeStatus.NotGraded, 10);
            List<PhotoSubmission> failedPhotos = await VotingService.GetTopPhotosByCompositionRuleAndGradeStatusAsync(rule.Id, GradeStatus.Fail, 10);
            
            if (passedPhotos.Any())
            {
                topPhotosByRule[(rule.Id, GradeStatus.Pass)] = passedPhotos;
            }
            if (ungradedPhotos.Any())
            {
                topPhotosByRule[(rule.Id, GradeStatus.NotGraded)] = ungradedPhotos;
            }
            if (failedPhotos.Any())
            {
                topPhotosByRule[(rule.Id, GradeStatus.Fail)] = failedPhotos;
            }
        }
        
        isLoading = false;
    }

    private string GetRankClass(int index)
    {
        return index switch
        {
            0 => "rank-gold",
            1 => "rank-silver",
            2 => "rank-bronze",
            _ => ""
        };
    }

    private string GetBadgeClass(int index)
    {
        return index switch
        {
            0 => "bg-warning text-dark",
            1 => "bg-light text-dark",
            2 => "bg-warning",
            _ => "bg-secondary"
        };
    }

    private string GetRankIcon(int index)
    {
        return index switch
        {
            0 => "ü•á",
            1 => "ü•à",
            2 => "ü•â",
            _ => ""
        };
    }

    private void ShowModal(PhotoSubmission submission)
    {
        selectedSubmission = submission;
    }

    private void CloseModal()
    {
        selectedSubmission = null;
    }
}
